<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>浅析如何定位，排除和避免MySQL性能故障</title>
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	
	<link rel="stylesheet" href="../../stylesheets/stylesheet.css" media="screen">
	<link rel="stylesheet" href="../../stylesheets/pygment_trac.css"/>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	<script type="text/javascript" src="../../javascripts/script.js"></script>
	
	<meta name="description" content="firstfhy">
	
	<meta name="viewport" content="width=device-width,initial-scale=1">
</head>
<body>
	<div class="wrapper">
		<div id="container">
		    <div id="main" role="main">
		    	<div class="download-bar">
			    	<div class="inner">
			          	<a class="code">SQL</a>
			        </div>
		        	<span class="blc"></span><span class="trc"></span>
		        </div>
		        <article class="markdown-body">
					<h3>
						浅析如何定位，排除和避免MySQL性能故障
				   	</h3>
<div id="blogDetailDiv" style="font-size:14px;">
                                                
                                                首先是如何检查SQL的效率.　　<span style="font-weight:bold"><wbr/>1.善用explain:</span><wbr/><br/>　　设计SQL后，应使用explain命令检查SQL，看是否使用到索引，是否存在filesort,重点检查检索的行数(rows)是否太大。<br/>　　一般来说.<br/>　　rows&lt;1000，是在可接受的范围内的。<br/>　　rows在1000~1w之间，在密集访问时可能导致性能问题，但如果不是太频繁的访问(频率低于1分钟一次)，又难再优化的话，可以接受，但需要注意观察<br/>　　rows大于1万时，应慎重考虑SQL的设计，优化SQL，优化db，一般来说不允许频繁运行(频率低于1小时一次)。<br/>　　rows达到10w级别时，坚决不能做为实时运行的SQL。但导数据场合除外，但导数据必须控制好时间，频度。<br/>　　explain SQL语句应该是日常开发中的习惯动作，有时explain出来的结果，可能会出于偏离设计的意料之外,所以<br/>　　**强烈建议在设计SQL，尤其是稍微复杂的SQL时，一定要在测试环境甚至是实际环境上预先进行explain**<br/>　　<span style="font-weight:bold"><wbr/>2.MySQL慢查询日志</span><wbr/><br/>　　一般应打开MySQL的慢查询日志(在my.cnf中加入log_slow_queries和long_query_time两个参数),会记录所有查询持续时间超过long_query_time的SQL语句，把这些语句log下来之后，再一一分析(explain)优化。<br/>　<span style="font-weight:bold"><wbr/>　3.监视当前<a href="http://whatis.ctocio.com.cn/searchwhatis/292/7333792.shtml" target="_blank"><span style="color:#16387c;line-height:1.8em;">进程</span><wbr/></a><wbr/></span><wbr/><br/>　　登陆MySQL,使用show processlist查看正在运行的SQL语句，如果正在运行的语句太多，运行时间太长，表示MySQL效率有问题。必要的时候可以将对应的进程kill掉。<br/><span style="font-weight:bold"><wbr/>　　4.系统命令</span><wbr/><br/>　　使用top/vmstat等系统命令来检查MySQL进程占用的cpu,内存,以及磁盘IO量。<br/>　　对MySQL优化的文章很多，这里只提几点平时工作中比较常用到的方法。<br/>　　◆建表时,显式指定使用innodb数据库引擎，而不是myisam,myisam引擎的锁是表锁,读锁和写锁是互斥的，读写操作是串行的，锁冲突会严重影响并发.而innodb提供行级锁，能提供较好的并发表现，在我们的业务场景里，也不会引起死锁。<br/>　　◆善用索引，对SQL语句where条件里使用到的字段，合理建立索引。虽然对表建立索引一定程度上会影响写入效率，但在表数据规模不大，写入压力不是特别高的情况下，索引带来的好处是更多的。<br/>　　◆当SQL语句是由代码动态生成的，如在运行时根据用户操作加入不同的where参数，应在测试阶段对SQL生成的典型情况和边界情况进行测试，看是否有可能造成性能问题。并应适当生成一些日志，供提取最终生成的SQL进行效率分析。<br/>&nbsp;&nbsp;&nbsp;&nbsp;◆对数据应合理分库分表，由应用层去动态的选择库和表。MySQL的innodb表虽然理论上可以装海量的数据，但在我们的业务场景下，数据控制在500w以下会比较合理，追求性能的话，最好控制在200w以下，合理索引。<br/>　　◆需要联合查询时善用left join/right join而不是直接多表联合，怎么用，查manul ^_^<br/>　　◆尽量不要使用select套select的复合查询，如果能拆开，尽量拆开,多条精悍的SQL,组合起来可能就是一条庞大的SQL，应该避免。<br/>　　◆善用<a href="http://whatis.ctocio.com.cn/searchwhatis/459/5946959.shtml" target="_blank"><span style="font-weight:bold"><wbr/><span style="color:#16387c;line-height:1.8em;">cache</span><wbr/></span><wbr/></a><wbr/>,将不常修改的，数据量有限的,又是被密集查询的信息，加载到cache里，可以有效的降低数据库压力。在一般的业务场景里，推荐使用<a href="http://whatis.ctocio.com.cn/searchwhatis/446/7372446.shtml" target="_blank"><span style="font-weight:bold"><wbr/><span style="color:#16387c;line-height:1.8em;">开源</span><wbr/></span><wbr/></a><wbr/>memcache，简单高效。<br/>　　◆如果一些逻辑可以放到应用层去完成，可以考虑放到应用层去完成。但如果将SQL逻辑分拆到应用层可能导致对数据更频繁的访问的话，那么需要考虑修改应用逻辑，数据结构，或回到合理的联合查询上来。<br/>　　比如某些数据的排序可以load到php数组里，再sort.又比如需要查询A,B两个表，A表里的数据是B表里某个字段的对照说明(如A:t_service表，B.t_task表)，A表数据量有限，可以做联合查询，也可以先将A表先load到<a href="http://whatis.ctocio.com.cn/searchwhatis/292/7333792.shtml" target="_blank"><span style="font-weight:bold"><wbr/><span style="color:#16387c;line-height:1.8em;">进程</span><wbr/></span><wbr/></a><wbr/>或内存里，用hash结构cache起来，再查B表，然后在cache里依次查询hash，获得对照说明。<br/>　　◆关于导数据和统计性查询.导数据在计算和磁盘io上对数据库压力都会很大，应在时间和空间上合理分摊数据库压力如果需要导出批量的特定数据做分析，应建立专供数据分析的数据库服务器，或者建立临时库表，先导出数据，再在上面做分析运算。<br/>　　导数据等可能引起批量数据读取的操作，应建立定时任务，在数据库不繁忙的时段(凌晨1~7时)运行一般的统计操作，对实时性要求都不会太高(5~10分钟以上，甚至一天，一周等)，这种数据不应在每次访问时运行库中直接count,group,而是应该由定时任务导出，建立结果表或中间结果表，供最终用户使用。<br/>　　◆生产数据库上的操作权限应严格控制，而开发人员在生产数据库上直接运行SQL语句，要尽量慎重。<br/>　　能做到以上这些，基本上可以算MySQL以及相关系统优化入门，可以保证不要让我们的数据库整天累趴下了。<br/>　　最后，即使做足了功课，也还是要例行的对数据库运行情况进行观察，监控，尽早发现其性能<a href="http://whatis.ctocio.com.cn/searchwhatis/146/7475146.shtml" target="_blank"><span style="font-weight:bold"><wbr/><span style="color:#16387c;line-height:1.8em;">瓶颈</span><wbr/></span><wbr/></a><wbr/>，在未造成危害前解决掉。
                                                
                                            </div>

				</article>
			</div>
		</div>
	    <footer>
			<div class="owner">
				<p><a href="https://github.com/firstfhy" class="avatar"><img src="https://avatars0.githubusercontent.com/u/10542465?v=3&amp;s=60" width="48" height="48"></a>View <a href="https://github.com/firstfhy">firstfhy</a> on <a href="https://www.github.com">GitHub</a></p>
			</div>
			<div class="creds">
			  	<small>This page generated using <a href="http://pages.github.com/">GitHub Pages</a><br>theme by <a href="https://twitter.com/jonrohan/">Jon Rohan</a></small>
			</div>
	    </footer>
	</div>
</body>
</html>
